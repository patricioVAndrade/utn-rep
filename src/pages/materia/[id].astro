---
import { supabase } from '../../lib/supabase';
import '../../styles/global.css';

// 1. Obtener el ID de la URL y el par√°metro "from" (de d√≥nde viene el user)
const { id } = Astro.params;
const from = Astro.url.searchParams.get('from'); // "nivel" si vino del explorador

// 2. Traer los datos de la materia
const { data: materia } = await supabase
  .from('materias')
  .select('*')
  .eq('id', id)
  .single();

// 3. Traer los dictados (Cursos y Profesores unidos)
const { data: dictados, error: dictadosError } = await supabase
  .from('dictados')
  .select(`
    id,
    cursos ( identificador, turno ),
    dictado_profesores (
      profesores ( nombre_completo )
    )
  `)
  .eq('materia_id', id);

if (dictadosError) {
  console.error("Error trayendo dictados:", dictadosError);
}

// Ordenar los dictados por el nombre del curso (ej: 3K1, 3K2...)
const dictadosOrdenados = dictados?.sort((a, b) => 
  a.cursos.identificador.localeCompare(b.cursos.identificador)
) || [];

// 4. Determinar color del header seg√∫n nivel
const nivelColors: Record<number, { bg: string; light: string; accent: string }> = {
  1: { bg: "from-blue-500 to-blue-600", light: "text-blue-200", accent: "bg-blue-100 text-blue-800" },
  2: { bg: "from-green-500 to-green-600", light: "text-green-200", accent: "bg-green-100 text-green-800" },
  3: { bg: "from-orange-500 to-orange-600", light: "text-orange-200", accent: "bg-orange-100 text-orange-800" },
  4: { bg: "from-red-500 to-red-600", light: "text-red-200", accent: "bg-red-100 text-red-800" },
  5: { bg: "from-purple-500 to-purple-600", light: "text-purple-200", accent: "bg-purple-100 text-purple-800" },
};

const nivel = materia?.nivel || 1;
const colors = nivelColors[nivel] || nivelColors[1];

// 5. Link de volver: si vino de un nivel, vuelve al nivel. Si no, vuelve al inicio.
const backLink = from === 'nivel' ? `/nivel/${nivel}` : '/';
const backLabel = from === 'nivel' ? `${nivel}¬∫ A√±o` : 'Inicio';
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <title>{materia?.nombre} - UTN Reviews</title>
  </head>
  <body class="bg-gradient-to-br from-slate-50 to-slate-100 text-gray-800 antialiased min-h-screen" style="font-family: 'Inter', sans-serif;">
    
    <!-- Header con color din√°mico seg√∫n nivel -->
    <header class={`bg-gradient-to-r ${colors.bg} text-white`}>
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12">
        <a href={backLink} class={`inline-flex items-center gap-2 ${colors.light} hover:text-white mb-4 transition-colors`}>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Volver a {backLabel}
        </a>
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <span class={`text-sm font-medium ${colors.light} uppercase tracking-wider`}>{nivel}¬∫ A√±o</span>
            <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold tracking-tight mt-1">
              {materia?.nombre}
            </h1>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-white/80 text-sm">{dictadosOrdenados.length} c√°tedra{dictadosOrdenados.length !== 1 ? 's' : ''}</span>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12">
      
      <!-- C√°tedras Disponibles -->
      <section class="mb-12">
        <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
          <span class="bg-slate-100 text-slate-600 p-2 rounded-xl">üè´</span>
          C√°tedras Disponibles
        </h2>
        
        {dictadosOrdenados.length > 0 ? (
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {dictadosOrdenados.map((dictado) => (
              <div class="bg-white rounded-2xl border border-gray-100 p-5 sm:p-6 hover:shadow-lg transition-all duration-300">
                <div class="flex justify-between items-start mb-3">
                  <h3 class="font-extrabold text-2xl text-gray-900">{dictado.cursos.identificador}</h3>
                  <span class={`text-xs font-bold ${colors.accent} px-3 py-1 rounded-lg uppercase tracking-wide`}>
                    {dictado.cursos.turno}
                  </span>
                </div>
                
                <div class="text-sm text-gray-600 mb-4">
                  <span class="font-semibold text-gray-800 block mb-2">Equipo Docente:</span>
                  <ul class="flex flex-col gap-1.5">
                    {dictado.dictado_profesores.map((dp: any) => (
                      <li class="flex items-center gap-2">
                        <span class="w-2 h-2 bg-indigo-400 rounded-full flex-shrink-0"></span>
                        <span>{dp.profesores.nombre_completo}</span>
                      </li>
                    ))}
                    {dictado.dictado_profesores.length === 0 && (
                      <li class="text-gray-400 italic">Profesores sin asignar</li>
                    )}
                  </ul>
                </div>
                
                <div class="pt-3 border-t border-gray-100 flex justify-between items-center text-sm">
                  <span class="text-yellow-500 font-bold flex items-center gap-1">
                    ‚≠ê 4.5 
                    <span class="text-gray-400 font-normal">(12 rese√±as)</span>
                  </span>
                  <button class="text-indigo-600 font-semibold hover:text-indigo-800 hover:underline transition-colors">
                    Ver opiniones
                  </button>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div class="text-center py-16 bg-white rounded-2xl border border-gray-100">
            <span class="text-5xl mb-4 block">üì≠</span>
            <h3 class="text-lg font-bold text-gray-700 mb-2">No hay c√°tedras cargadas</h3>
            <p class="text-gray-500">Todav√≠a no se registraron cursos para esta materia.</p>
          </div>
        )}
      </section>

      <!-- Opiniones Recientes -->
      <section class="mb-12">
        <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
          <span class="bg-amber-100 text-amber-600 p-2 rounded-xl">üí¨</span>
          Opiniones Recientes
        </h2>
        <div class="bg-white p-8 sm:p-12 text-center border-2 border-dashed border-gray-200 rounded-2xl">
          <span class="text-4xl mb-3 block">üó£Ô∏è</span>
          <p class="text-gray-500">Las opiniones de los estudiantes aparecer√°n ac√°.</p>
        </div>
      </section>

      <!-- Bot√≥n escribir rese√±a -->
      <div class="fixed bottom-6 left-4 right-4 sm:left-auto sm:right-8 sm:w-auto z-20">
        <button class={`w-full sm:w-auto bg-gradient-to-r ${colors.bg} hover:opacity-90 text-white font-bold text-base sm:text-lg px-8 py-4 rounded-2xl shadow-xl transition-all active:scale-95 flex items-center justify-center gap-2`}>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
            <path d="M21.731 2.269a2.625 2.625 0 00-3.712 0l-1.157 1.158 3.71 3.71 1.159-1.157a2.625 2.625 0 000-3.711z" />
            <path d="M10.74 15.394l6.5-6.5-3.71-3.71-6.5 6.5a1.5 1.5 0 00-.4.73l-.84 4.2a.75.75 0 00.916.916l4.2-.84a1.5 1.5 0 00.73-.4z" />
          </svg>
          Escribir una rese√±a
        </button>
      </div>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-400 mt-16 pb-24 sm:pb-0">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
          <div class="text-center sm:text-left">
            <p class="font-bold text-white">UTN Reviews</p>
            <p class="text-sm">Hecho por estudiantes, para estudiantes</p>
          </div>
          <div class="flex gap-6 text-sm">
            <a href="/" class="hover:text-white transition-colors">Inicio</a>
            <a href="/sobre-nosotros" class="hover:text-white transition-colors">Sobre Nosotros</a>
          </div>
        </div>
      </div>
    </footer>

  </body>
</html>