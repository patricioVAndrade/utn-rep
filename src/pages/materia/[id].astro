---
import Layout from '../../layouts/Layout.astro';
import HeaderNav from '../../components/HeaderNav.astro';
import { supabase } from '../../lib/supabase';
import { isAdmin } from '../../lib/admin';

const user = Astro.locals.user;
const userIsAdmin = isAdmin(user?.id);

// Obtener el ID de la URL y el parámetro "from"
const { id } = Astro.params;
const from = Astro.url.searchParams.get('from');

// Traer los datos de la materia
const { data: materia } = await supabase
  .from('materias')
  .select('*')
  .eq('id', id)
  .single();

if (!materia) {
  return Astro.redirect('/404');
}

// Traer los dictados con cursos y profesores
const { data: dictados } = await supabase
  .from('dictados')
  .select(`
    id,
    cursos ( identificador, turno ),
    dictado_profesores (
      profesores ( nombre_completo )
    )
  `)
  .eq('materia_id', id);

const dictadosOrdenados = dictados?.sort((a, b) => {
  // Natural sort: extract numeric part after letter (e.g. "2K10" → 10)
  const numA = parseInt(a.cursos.identificador.replace(/\D+/g, '').slice(1) || '0');
  const numB = parseInt(b.cursos.identificador.replace(/\D+/g, '').slice(1) || '0');
  const prefixA = a.cursos.identificador.replace(/\d+$/, '');
  const prefixB = b.cursos.identificador.replace(/\d+$/, '');
  if (prefixA !== prefixB) return prefixA.localeCompare(prefixB);
  return numA - numB;
}) || [];

// Traer reseñas y calcular estadísticas reales
const dictadoIds = dictados?.map(d => d.id) || [];
let resenas: any[] = [];
let promedioGeneral = "0.0";
let dictadoStats: Record<number, { promedio: string, count: number }> = {};

if (dictadoIds.length > 0) {
  // Try reading from the public view first (may not exist yet). Fallback to base table.
  let resenasData: any[] | null = null;
  try {
    const r = await supabase
      .from('public_resenas')
      .select('*')
      .in('dictado_id', dictadoIds)
      .order('created_at', { ascending: false });
    // @ts-ignore
    if (!r.error && r.data) resenasData = r.data;
  } catch (e) {
    resenasData = null;
  }

  if (!resenasData) {
    const r2 = await supabase
      .from('resenas')
      .select('*')
      .in('dictado_id', dictadoIds)
      .order('created_at', { ascending: false });
    // @ts-ignore
    resenasData = r2.data || [];
  }

  resenas = resenasData || [];
  
  if (resenas.length > 0) {
    const suma = resenas.reduce((acc: number, r: any) => acc + r.calificacion_general, 0);
    promedioGeneral = (suma / resenas.length).toFixed(1);
  }

  dictadoIds.forEach(did => {
    const resenasCurso = resenas.filter((r: any) => r.dictado_id === did);
    if (resenasCurso.length > 0) {
      const suma = resenasCurso.reduce((acc: number, r: any) => acc + r.calificacion_general, 0);
      dictadoStats[did] = {
        promedio: (suma / resenasCurso.length).toFixed(1),
        count: resenasCurso.length
      };
    } else {
      dictadoStats[did] = { promedio: "0.0", count: 0 };
    }
  });
}

// Color por nivel
const nivelColors: Record<number, { bg: string; light: string; accent: string }> = {
  1: { bg: "from-blue-500 to-blue-600", light: "text-blue-200", accent: "bg-blue-900/30 text-blue-400" },
  2: { bg: "from-green-500 to-green-600", light: "text-green-200", accent: "bg-green-900/30 text-green-400" },
  3: { bg: "from-orange-500 to-orange-600", light: "text-orange-200", accent: "bg-orange-900/30 text-orange-400" },
  4: { bg: "from-red-500 to-red-600", light: "text-red-200", accent: "bg-red-900/30 text-red-400" },
  5: { bg: "from-purple-500 to-purple-600", light: "text-purple-200", accent: "bg-purple-900/30 text-purple-400" },
};

const nivel = materia?.nivel || 1;
const colors = nivelColors[nivel] || nivelColors[1];

const backLink = from === 'nivel' ? `/nivel/${nivel}` : '/';
const backLabel = from === 'nivel' ? `${nivel}º Año` : 'Inicio';

function tiempoRelativo(fecha: string): string {
  const diff = Date.now() - new Date(fecha).getTime();
  const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
  if (dias === 0) return 'Hoy';
  if (dias === 1) return 'Ayer';
  if (dias < 30) return `Hace ${dias} días`;
  if (dias < 365) return `Hace ${Math.floor(dias / 30)} mes${Math.floor(dias / 30) > 1 ? 'es' : ''}`;
  return `Hace ${Math.floor(dias / 365)} año${Math.floor(dias / 365) > 1 ? 's' : ''}`;
}
---

<Layout title={`${materia?.nombre} - UTN REP`} hasFloatingButton={true}>
    
  <header class={`bg-gradient-to-r ${colors.bg} text-white shadow-md relative overflow-hidden`}>
    <div class="absolute inset-0 dot-pattern opacity-30"></div>
    <div class="relative max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-4 pb-8 lg:pb-12">
      <HeaderNav user={user} />
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <span class={`text-sm font-medium ${colors.light} uppercase tracking-wider`}>{nivel}º Año</span>
          <h1 class="text-3xl sm:text-4xl lg:text-5xl font-heading font-extrabold tracking-tight mt-1">
            {materia?.nombre}
          </h1>
        </div>
        <div class="flex items-center gap-4 bg-white/10 px-4 py-2 rounded-xl backdrop-blur-sm">
          <div class="text-right">
            <span class="text-white text-lg font-black block leading-none">★ {promedioGeneral}</span>
            <span class="text-white/80 text-xs uppercase tracking-wider">{resenas.length} reseñas</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12">
    
    <!-- Cátedras -->
    <section class="mb-12">
      <h2 class="text-xl sm:text-2xl font-heading font-bold text-neutral-100 mb-6 flex items-center gap-3">
        <span class="bg-neutral-700 text-neutral-300 p-2 rounded-xl shadow-sm"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg></span>
        Todos Los Cursos
      </h2>
      
      {dictadosOrdenados.length > 0 ? (
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
          {dictadosOrdenados.map((dictado) => {
            const stats = dictadoStats[dictado.id] || { promedio: "0.0", count: 0 };
            return (
              <a href={`/dictado/${dictado.id}`} class="bg-[#242424] rounded-2xl border border-neutral-700/60 p-5 sm:p-6 hover:shadow-xl hover:-translate-y-1 hover:border-amber-300 transition-all duration-300 flex flex-col">
                <div class="flex justify-between items-start mb-3">
                  <h3 class="font-heading font-extrabold text-2xl text-white">{dictado.cursos.identificador}</h3>
                  <span class={`text-xs font-bold ${colors.accent} px-3 py-1 rounded-lg uppercase tracking-wide`}>
                    {dictado.cursos.turno}
                  </span>
                </div>
                
                <div class="text-sm text-neutral-400 mb-4 flex-1">
                  <span class="font-semibold text-neutral-100 block mb-2">Equipo Docente:</span>
                  <ul class="flex flex-col gap-1.5">
                    {dictado.dictado_profesores.map((dp: any) => (
                      <li class="flex items-center gap-2">
                        <span class="w-2 h-2 bg-amber-400 rounded-full flex-shrink-0"></span>
                        <span class="font-medium text-neutral-300">{dp.profesores.nombre_completo}</span>
                      </li>
                    ))}
                    {dictado.dictado_profesores.length === 0 && (
                      <li class="text-neutral-500 italic">Profesores sin asignar</li>
                    )}
                  </ul>
                </div>
                
                <div class="pt-4 border-t border-neutral-700 flex justify-between items-center text-sm mt-auto">
                  {stats.count > 0 ? (
                    <span class="text-amber-500 font-bold flex items-center gap-1">
                      &#11088; {stats.promedio} 
                      <span class="text-neutral-500 font-medium text-xs ml-1">({stats.count})</span>
                    </span>
                  ) : (
                    <span class="text-neutral-500 font-medium text-xs">Sin reseñas</span>
                  )}
                  <span class="text-amber-400 font-semibold text-sm">
                    Ver Reseñas →
                  </span>
                </div>
              </a>
            );
          })}
        </div>
      ) : (
        <div class="text-center py-16 bg-[#242424] rounded-2xl border border-neutral-700/60 shadow-sm">
          <div class="flex justify-center mb-4">
            <svg class="w-14 h-14 text-neutral-600" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>
          </div>
          <h3 class="text-lg font-heading font-bold text-neutral-300 mb-2">No hay cátedras cargadas</h3>
          <p class="text-neutral-500">Todavía no se registraron cursos para esta materia.</p>
        </div>
      )}
    </section>

    <!-- Opiniones Recientes -->
    <section class="mb-24">
      <h2 class="text-xl sm:text-2xl font-heading font-bold text-neutral-100 mb-6 flex items-center gap-3">
        <span class="bg-amber-900/30 text-amber-400 p-2 rounded-xl shadow-sm"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg></span>
        Opiniones Recientes
      </h2>
      
      {resenas.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {resenas.slice(0, 6).map((resena: any) => {
            const dictadoInfo = dictadosOrdenados.find(d => d.id === resena.dictado_id);
            const cursoNombre = dictadoInfo ? dictadoInfo.cursos.identificador : 'Curso';
            return (
              <div class="bg-[#242424] p-6 rounded-2xl border border-neutral-700/60 shadow-sm hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start mb-3">
                  <div class="flex items-center gap-3">
                    <div class={`w-9 h-9 bg-gradient-to-br ${resena.es_anonima ? 'from-neutral-700 to-neutral-800' : colors.bg} rounded-full flex items-center justify-center text-white font-bold text-sm`}>
                      {resena.es_anonima ? (
                        <svg class="w-4 h-4 text-neutral-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                      ) : (
                        (resena.nombre_usuario || 'E').charAt(0).toUpperCase()
                      )}
                    </div>
                    <div>
                      <div class="flex items-center gap-1.5">
                        <p class="font-semibold text-neutral-100 text-sm">
                          {resena.es_anonima ? 'Anónimo' : (resena.nombre_usuario || 'Estudiante')}
                          {resena.es_anonima && userIsAdmin && (
                            <span class="text-[10px] text-red-400/70 font-normal ml-1" title="Visible solo para admin">({resena.nombre_usuario})</span>
                          )}
                        </p>
                        {resena.es_alumno_utn && (
                          <span class="inline-flex items-center gap-0.5 bg-blue-900/40 text-blue-400 text-[10px] font-bold px-1.5 py-0.5 rounded-full border border-blue-700/50" title="Alumno verificado de UTN FRC">
                            <svg class="w-2.5 h-2.5" fill="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                            UTN
                          </span>
                        )}
                      </div>
                      <span class={`font-bold ${colors.accent} px-2 py-0.5 rounded text-xs tracking-wide`}>
                        {cursoNombre}
                      </span>
                    </div>
                  </div>
                  <span class="text-yellow-400 font-bold tracking-widest text-lg drop-shadow-sm flex-shrink-0">
                    {"★".repeat(resena.calificacion_general)}{"☆".repeat(5 - resena.calificacion_general)}
                  </span>
                </div>
                <p class="text-neutral-300 font-medium italic mb-4">"{resena.comentario}"</p>
                <div class="text-xs text-neutral-500 font-medium flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                  Cursado en {resena.anio_cursado}
                  {resena.created_at && ` · ${tiempoRelativo(resena.created_at)}`}
                </div>
              </div>
            );
          })}
        </div>
      ) : (
        <div class="bg-[#242424] p-8 sm:p-12 text-center border-2 border-dashed border-neutral-700 rounded-2xl">
          <div class="flex justify-center mb-3">
            <svg class="w-12 h-12 text-neutral-600" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
          </div>
          <h3 class="text-lg font-heading font-bold text-neutral-300 mb-2">Todavía no hay opiniones</h3>
          <p class="text-neutral-500">Sé el primero en compartir tu experiencia en esta materia.</p>
        </div>
      )}
    </section>

    <!-- Botón flotante -->
    <div class="fixed bottom-6 left-4 right-4 sm:left-auto sm:right-8 sm:w-auto z-20">
      <a href={`/nueva-resena?materia=${id}&from=/materia/${id}`} class={`w-full sm:w-auto bg-gradient-to-r ${colors.bg} hover:opacity-90 text-white font-bold text-base sm:text-lg px-8 py-4 rounded-2xl shadow-xl shadow-blue-900/20 transition-all active:scale-95 flex items-center justify-center gap-2`}>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M21.731 2.269a2.625 2.625 0 00-3.712 0l-1.157 1.158 3.71 3.71 1.159-1.157a2.625 2.625 0 000-3.711z" />
          <path d="M10.74 15.394l6.5-6.5-3.71-3.71-6.5 6.5a1.5 1.5 0 00-.4.73l-.84 4.2a.75.75 0 00.916.916l4.2-.84a1.5 1.5 0 00.73-.4z" />
        </svg>
        Escribir una reseña
      </a>
    </div>

  </main>

</Layout>
