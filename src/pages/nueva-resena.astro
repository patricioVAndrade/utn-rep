---
import Layout from '../layouts/Layout.astro';
import HeaderNav from '../components/HeaderNav.astro';
import { supabase } from '../lib/supabase';

const user = Astro.locals.user;

// Verificar si viene con dictado preseleccionado
const dictadoIdParam = Astro.url.searchParams.get('dictado');

// Verificar si viene con materia preseleccionada (desde página de materia)
const materiaIdParam = Astro.url.searchParams.get('materia');

// Guardar de dónde vino el usuario para redirigir después de enviar
const fromParam = Astro.url.searchParams.get('from') || '';

let dictadoInfo: any = null;
if (dictadoIdParam) {
  const { data } = await supabase
    .from('dictados')
    .select(`
      id,
      cursos ( identificador, turno ),
      materias ( id, nombre, nivel )
    `)
    .eq('id', dictadoIdParam)
    .single();
  dictadoInfo = data;
}

// Info de materia preseleccionada
let materiaPreseleccionada: any = null;
if (materiaIdParam && !dictadoIdParam) {
  const { data } = await supabase
    .from('materias')
    .select('id, nombre, nivel')
    .eq('id', materiaIdParam)
    .single();
  materiaPreseleccionada = data;
}

// Materias para el selector (solo si no viene con dictado)
let materias: any[] = [];
if (!dictadoIdParam) {
  const { data } = await supabase
    .from('materias')
    .select('id, nombre, nivel')
    .order('nivel')
    .order('nombre');
  materias = data || [];
}

const nivel = dictadoInfo?.materias?.nivel || materiaPreseleccionada?.nivel || 3;
const nivelColors: Record<number, string> = {
  1: "from-blue-500 to-blue-600",
  2: "from-green-500 to-green-600",
  3: "from-orange-500 to-orange-600",
  4: "from-red-500 to-red-600",
  5: "from-purple-500 to-purple-600",
};
const headerBg = (dictadoInfo || materiaPreseleccionada) ? (nivelColors[nivel] || "from-stone-700 to-stone-900") : "from-stone-700 to-stone-900";

const currentYear = new Date().getFullYear();
---

<Layout title="Nueva Reseña - UTN REP">

  <!-- Header -->
  <header class={`bg-gradient-to-r ${headerBg} text-white relative overflow-hidden`}>
    <div class="absolute inset-0 dot-pattern opacity-30"></div>
    <div class="relative max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-4 pb-8 lg:pb-10">
      <HeaderNav user={user} />
      {dictadoInfo && (
        <a href={`/dictado/${dictadoIdParam}`} class="inline-flex items-center gap-2 text-white/70 hover:text-white mb-2 transition-colors text-sm">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Volver a {dictadoInfo.cursos.identificador}
        </a>
      )}
      {!dictadoInfo && materiaPreseleccionada && (
        <a href={`/materia/${materiaPreseleccionada.id}`} class="inline-flex items-center gap-2 text-white/70 hover:text-white mb-2 transition-colors text-sm">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Volver a {materiaPreseleccionada.nombre}
        </a>
      )}
      <h1 class="text-3xl sm:text-4xl font-heading font-extrabold tracking-tight flex items-center gap-3">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
        Nueva Reseña
      </h1>
      {dictadoInfo && (
        <p class="text-white/80 mt-2">
          {dictadoInfo.materias.nombre} · {dictadoInfo.cursos.identificador} · Turno {dictadoInfo.cursos.turno}
        </p>
      )}

    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12">
    
    {/* Auth guard: must be logged in */}
    {!user ? (
      <div class="bg-[#242424] rounded-2xl border border-neutral-700/60 p-8 text-center">
        <div class="flex justify-center mb-4">
          <svg class="w-14 h-14 text-neutral-500" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
        </div>
        <h2 class="text-xl font-heading font-bold text-neutral-100 mb-2">Iniciá sesión para escribir una reseña</h2>
        <p class="text-neutral-500 mb-6 text-sm">
          Necesitás una cuenta para poder dejar tu opinión. Es rápido y seguro.
        </p>
        <button id="login-btn-main" class="inline-flex items-center gap-2 bg-gradient-to-r from-amber-500 to-amber-600 text-white font-bold px-8 py-4 rounded-xl hover:opacity-90 transition-all shadow-lg cursor-pointer">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          Iniciar Sesión
        </button>
      </div>
    ) : (
    <div>
    <!-- Mensajes -->
    <div id="msg-success" class="hidden mb-6 bg-green-900/30 border border-green-700 text-green-400 px-6 py-4 rounded-2xl">
      <p class="font-bold flex items-center gap-2"><svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> ¡Reseña enviada!</p>
      <p class="text-sm mt-1">Gracias por compartir tu experiencia.</p>
    </div>
    <div id="msg-error" class="hidden mb-6 bg-red-900/30 border border-red-700 text-red-400 px-6 py-4 rounded-2xl">
      <p class="font-bold flex items-center gap-2"><svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Hubo un error</p>
      <p class="text-sm mt-1" id="msg-error-text">No se pudo enviar la reseña. Intentá de nuevo.</p>
    </div>

    <form id="review-form" class="space-y-6">
      
      {/* Modo completo: Seleccionar materia y curso */}
      {!dictadoInfo && (
        <div class="bg-[#242424] rounded-2xl border border-neutral-700/60 p-6 space-y-5">
          <h2 class="font-heading font-bold text-lg text-neutral-100 flex items-center gap-2">
            <span class="bg-amber-900/30 text-amber-400 p-1.5 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg></span>
            ¿Qué materia y curso cursaste?
          </h2>
          
          <div>
            <label for="materia-select" class="block text-sm font-semibold text-neutral-300 mb-2">Materia</label>
            <select 
              id="materia-select" 
              class={`w-full px-4 py-3 rounded-xl border border-neutral-700 bg-[#242424] text-neutral-100 focus:outline-none focus:ring-2 focus:ring-amber-300 focus:border-amber-400 transition-all ${materiaPreseleccionada ? 'opacity-70 cursor-not-allowed' : ''}`}
              required
              disabled={!!materiaPreseleccionada}
            >
              <option value="">Seleccioná una materia...</option>
              {[1, 2, 3, 4, 5].map((niv) => {
                const materiasNivel = materias.filter(m => m.nivel === niv);
                return materiasNivel.length > 0 && (
                  <optgroup label={`${niv}º Año`}>
                    {materiasNivel.map(m => (
                      <option value={m.id} selected={materiaPreseleccionada?.id === m.id}>{m.nombre}</option>
                    ))}
                  </optgroup>
                );
              })}
            </select>
            {materiaPreseleccionada && (
              <input type="hidden" id="materia-hidden" value={materiaPreseleccionada.id} />
            )}
          </div>

          <div>
            <label for="curso-select" class="block text-sm font-semibold text-neutral-300 mb-2">Curso / Cátedra</label>
            <select 
              id="curso-select" 
              class="w-full px-4 py-3 rounded-xl border border-neutral-700 bg-[#242424] text-neutral-100 focus:outline-none focus:ring-2 focus:ring-amber-300 focus:border-amber-400 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
              required
              disabled={!materiaPreseleccionada}
            >
              <option value="">{materiaPreseleccionada ? 'Cargando cursos...' : 'Primero seleccioná una materia'}</option>
            </select>
          </div>
        </div>
      )}

      {dictadoInfo && (
        <input type="hidden" id="dictado-id-hidden" value={dictadoIdParam} />
      )}

      <!-- Calificación -->
      <div class="bg-[#242424] rounded-2xl border border-neutral-700/60 p-6">
        <h2 class="font-heading font-bold text-lg text-neutral-100 mb-4 flex items-center gap-2">
          <span class="bg-amber-900/30 text-amber-400 p-1.5 rounded-lg"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
          ¿Cómo calificarías tu experiencia?
        </h2>
        
        <div class="flex items-center justify-center gap-2 sm:gap-3" id="star-rating">
          {[1, 2, 3, 4, 5].map((star) => (
            <button 
              type="button"
              data-star={star}
              class="star-btn text-4xl sm:text-5xl text-neutral-300 hover:text-yellow-400 transition-all duration-150 hover:scale-110 active:scale-95 cursor-pointer"
              aria-label={`${star} estrella${star > 1 ? 's' : ''}`}
            >
              ★
            </button>
          ))}
        </div>
        <input type="hidden" id="calificacion" name="calificacion" value="0" required />
        <p id="rating-label" class="text-center text-sm text-neutral-500 mt-3">Tocá una estrella para calificar</p>
      </div>

      <!-- Año de cursado -->
      <div class="bg-[#242424] rounded-2xl border border-neutral-700/60 p-6">
        <h2 class="font-heading font-bold text-lg text-neutral-100 mb-4 flex items-center gap-2">
          <span class="bg-blue-900/30 text-blue-400 p-1.5 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></span>
          ¿En qué año cursaste?
        </h2>
        <select 
          id="anio-cursado" 
          class="w-full px-4 py-3 rounded-xl border border-neutral-700 bg-[#242424] text-neutral-100 focus:outline-none focus:ring-2 focus:ring-amber-300 focus:border-amber-400 transition-all"
          required
        >
          <option value="">Seleccioná el año...</option>
          {Array.from({length: 10}, (_, i) => currentYear - i).map((year) => (
            <option value={year}>{year}</option>
          ))}
        </select>
      </div>

      <!-- Comentario -->
      <div class="bg-[#242424] rounded-2xl border border-neutral-700/60 p-6">
        <h2 class="font-heading font-bold text-lg text-neutral-100 mb-4 flex items-center gap-2">
          <span class="bg-neutral-800 text-neutral-400 p-1.5 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg></span>
          Tu opinión
        </h2>
        <textarea 
          id="comentario"
          class="w-full px-4 py-3 rounded-xl border border-neutral-700 bg-[#242424] text-neutral-100 focus:outline-none focus:ring-2 focus:ring-amber-300 focus:border-amber-400 transition-all resize-none"
          rows="5"
          placeholder="Contá tu experiencia: ¿Cómo son las clases? ¿Los parciales? ¿Los profes explican bien? Cualquier dato es útil..."
          required
        ></textarea>
        <p class="text-xs text-neutral-500 mt-2">Tu nombre aparecerá junto a tu reseña. Sé respetuoso/a con los docentes.</p>
      </div>

      <!-- Botón enviar -->
      <button 
        type="submit" 
        id="btn-submit"
        class="w-full bg-gradient-to-r from-amber-500 to-amber-600 hover:opacity-90 text-white font-bold text-lg px-8 py-4 rounded-2xl shadow-xl transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
        </svg>
        Enviar Reseña
      </button>
    </form>
    </div>
    )}

  </main>

  <script define:vars={{ dictadoIdParam, fromParam, supabaseUrl: import.meta.env.PUBLIC_SUPABASE_URL, supabaseKey: import.meta.env.PUBLIC_SUPABASE_ANON_KEY }}>
    // ========== STAR RATING ==========
    let selectedRating = 0;
    const labels = ['', 'Muy malo', 'Malo', 'Regular', 'Bueno', 'Excelente'];
    const starBtns = document.querySelectorAll('.star-btn');
    const calInput = document.getElementById('calificacion');
    const ratingLabel = document.getElementById('rating-label');

    starBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        selectedRating = parseInt(btn.dataset.star);
        calInput.value = selectedRating;
        ratingLabel.textContent = labels[selectedRating];
        ratingLabel.classList.remove('text-neutral-500');
        ratingLabel.classList.add('text-neutral-300', 'font-medium');
        
        starBtns.forEach(b => {
          const star = parseInt(b.dataset.star);
          if (star <= selectedRating) {
            b.classList.remove('text-neutral-300');
            b.classList.add('text-yellow-400');
          } else {
            b.classList.remove('text-yellow-400');
            b.classList.add('text-neutral-300');
          }
        });
      });

      btn.addEventListener('mouseenter', () => {
        const hoverStar = parseInt(btn.dataset.star);
        starBtns.forEach(b => {
          if (parseInt(b.dataset.star) <= hoverStar) b.classList.add('text-yellow-300');
        });
      });
      btn.addEventListener('mouseleave', () => {
        starBtns.forEach(b => {
          b.classList.remove('text-yellow-300');
          const star = parseInt(b.dataset.star);
          if (star <= selectedRating) {
            b.classList.remove('text-neutral-300');
            b.classList.add('text-yellow-400');
          } else {
            b.classList.remove('text-yellow-400');
            b.classList.add('text-neutral-300');
          }
        });
      });
    });

    // ========== MATERIA → CURSO DINÁMICO ==========
    const materiaSelect = document.getElementById('materia-select');
    const cursoSelect = document.getElementById('curso-select');
    const materiaHidden = document.getElementById('materia-hidden');

    async function loadCursos(materiaId) {
      if (!cursoSelect) return;
      cursoSelect.innerHTML = '<option value="">Cargando cursos...</option>';
      cursoSelect.disabled = true;

      if (!materiaId) {
        cursoSelect.innerHTML = '<option value="">Primero seleccioná una materia</option>';
        return;
      }

      try {
        const res = await fetch(supabaseUrl + '/rest/v1/dictados?materia_id=eq.' + materiaId + '&select=id,cursos(identificador,turno)', {
          headers: { 'apikey': supabaseKey, 'Authorization': 'Bearer ' + supabaseKey }
        });
        const dictados = await res.json();

        if (dictados.length === 0) {
          cursoSelect.innerHTML = '<option value="">No hay cursos para esta materia</option>';
          return;
        }

        dictados.sort((a, b) => a.cursos.identificador.localeCompare(b.cursos.identificador));

        cursoSelect.innerHTML = '<option value="">Elegí un curso...</option>';
        dictados.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.textContent = d.cursos.identificador + ' - Turno ' + d.cursos.turno;
          cursoSelect.appendChild(opt);
        });
        cursoSelect.disabled = false;
      } catch (err) {
        console.error('Error cargando cursos:', err);
        cursoSelect.innerHTML = '<option value="">Error al cargar cursos</option>';
      }
    }

    // Si viene con materia preseleccionada, cargar cursos automáticamente
    if (materiaHidden) {
      loadCursos(materiaHidden.value);
    }

    if (materiaSelect && cursoSelect) {
      materiaSelect.addEventListener('change', async () => {
        const materiaId = materiaSelect.value;
        await loadCursos(materiaId);
      });
    }

    // ========== ENVIAR RESEÑA ==========
    const form = document.getElementById('review-form');
    const btnSubmit = document.getElementById('btn-submit');
    const msgSuccess = document.getElementById('msg-success');
    const msgError = document.getElementById('msg-error');
    const msgErrorText = document.getElementById('msg-error-text');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      msgSuccess.classList.add('hidden');
      msgError.classList.add('hidden');

      let dictadoId = dictadoIdParam;
      if (!dictadoId) dictadoId = cursoSelect?.value;

      const calificacion = parseInt(calInput.value);
      const anio = parseInt(document.getElementById('anio-cursado').value);
      const comentario = document.getElementById('comentario').value.trim();

      if (!dictadoId) {
        msgErrorText.textContent = 'Seleccioná una materia y un curso.';
        msgError.classList.remove('hidden');
        return;
      }
      if (!calificacion || calificacion < 1) {
        msgErrorText.textContent = 'Seleccioná una calificación (1 a 5 estrellas).';
        msgError.classList.remove('hidden');
        return;
      }
      if (!anio) {
        msgErrorText.textContent = 'Seleccioná el año en que cursaste.';
        msgError.classList.remove('hidden');
        return;
      }
      if (!comentario) {
        msgErrorText.textContent = 'Escribí un comentario sobre tu experiencia.';
        msgError.classList.remove('hidden');
        return;
      }

      btnSubmit.disabled = true;
      btnSubmit.innerHTML = '<span class="animate-spin inline-block w-5 h-5 border-2 border-white border-t-transparent rounded-full"></span> Enviando...';

      try {
        const res = await fetch('/api/resenas', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            dictado_id: parseInt(dictadoId),
            calificacion_general: calificacion,
            anio_cursado: anio,
            comentario: comentario
          })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Error ' + res.status);
        }

        // Redirigir al origen después de un envío exitoso
        // Si vino de un dictado específico, volver ahí. Si no, al home.
        let redirectUrl = '/';
        if (fromParam) {
          redirectUrl = fromParam;
        } else if (dictadoIdParam) {
          redirectUrl = '/dictado/' + dictadoIdParam;
        }
        
        // Breve delay para que se vea el mensaje de éxito
        msgSuccess.classList.remove('hidden');
        msgSuccess.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => {
          window.location.href = redirectUrl;
        }, 1500);

      } catch (err) {
        console.error('Error enviando reseña:', err);
        msgErrorText.textContent = err.message || 'No se pudo enviar la reseña. Intentá de nuevo.';
        msgError.classList.remove('hidden');
      } finally {
        btnSubmit.disabled = false;
        btnSubmit.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg> Enviar Reseña';
      }
    });
  </script>

</Layout>
